# 计算差异基因并且进行富集分析

## 1计算差异基因

### 读入数据

```R
library(Seurat)
library(ggplot2)
library(dplyr)
library(tidyverse)
library(patchwork)

# load data
# -----> Myeloids
load("/root/wangje/Project/刘老师/Myeloids/Data/Myeloids_CCA.RData")
DefautAssay(scRNA_seurat) <- 'RNA'

# -----> NK & T cells
load('/root/wangje/Project/刘老师/NK_T/Data/new_NKT_CCA.RData')
DefaultAssay(scRNA_seurat) <- 'RNA'


```

### 进行差异分析

```R

Find_DEGs <- function(data,ident.1 = 'R_Post', 
                      ident.2 = 'R_Pre', 
                      group='Treat_assess',
                      idents = 'new_celltype'){
  flist = list()
  if(DefaultAssay(data) != 'RNA'){
    DefaultAssay(data) = 'RNA'
    Idents(data) = idents
  } 
  for(celltype in unique(Idents(data))){
    print(celltype)
    res = FindMarkers(
      object = data,
      ident.1 = ident.1,
      ident.2 = ident.2,
      group.by = group,
      subset.ident = celltype,
      only.pos = F
    )
    print(dim(res))
    flist[[celltype]] <- res
  }
  return(flist)
}

# ------> Myeloids
R_Post_R_Pre <- Find_DEGs(data = scRNA_seurat, group = 'Treat_assess')
NR_Post_NR_Pre <- Find_DEGs(data = scRNA_seurat, ident.1 = 'NR_Post', ident.2 = 'NR_Pre',group = 'Treat_assess')
NR_Post_R_Post <- Find_DEGs(data = scRNA_seurat, ident.1 = 'NR_Post', ident.2 = 'R_Post',group = 'Treat_assess')
NR_Pre_R_Pre <- Find_DEGs(data = scRNA_seurat, ident.1 = 'NR_Pre', ident.2 = 'R_Pre',group = 'Treat_assess')

# -------> NK & T cells
R_Post_R_Pre <- Find_DEGs(data = scRNA_seurat, group = 'Treat_assess',idents = 'celltype')
NR_Post_NR_Pre <- Find_DEGs(data = scRNA_seurat, ident.1 = 'NR_Post', ident.2 = 'NR_Pre',group = 'Treat_assess', idents = 'celltype')
NR_Post_R_Post <- Find_DEGs(data = scRNA_seurat, ident.1 = 'NR_Post', ident.2 = 'R_Post',group = 'Treat_assess', idents = 'celltype')
NR_Pre_R_Pre <- Find_DEGs(data = scRNA_seurat, ident.1 = 'NR_Pre', ident.2 = 'R_Pre',group = 'Treat_assess', idents = 'celltype')

```

### 进行GO富集分析

```R
go_enrichment_analysis <- function(data,
                                   title1 = '',
                                   title2 = '') {
    plist_up <- list()
    plist_down <- list()
    
    for (i in names(data)) {
        print(i)
        # 区分出上调和下调的基因 avg_log2FC
        data_up = data[[i]] %>% dplyr::filter(avg_log2FC > 0)
        data_down = data[[i]] %>% dplyr::filter(avg_log2FC < 0)
        
        tmp_up <- enrichGO(
            gene = rownames(data_up),
            OrgDb = "org.Hs.eg.db",
            keyType = "SYMBOL",
            ont = "BP",
            pAdjustMethod = "BH"
        )
        
        tmp_down <- enrichGO(
            gene = rownames(data_down),
            OrgDb = "org.Hs.eg.db",
            keyType = "SYMBOL",
            ont = "BP",
            pAdjustMethod = "BH"
        )
        
        plist_up[[i]] = barplot(tmp_up, showCategory = 15) + labs(title = paste0(i, '-->', title1))
        plist_down[[i]] = barplot(tmp_down, showCategory = 15) + labs(title = paste0(i, '-->', title2))
    }
    
    result_list <- list(plist_up, plist_down)
    return(result_list)
}

# ----> Macrophage
go_enrichment_analysis(data = R_Post_R_Pre, title1 = 'R_Post vs R_Pre up', title2 = 'R_Post vs R_Pre down')

```

### 进行KEGG分析

```R